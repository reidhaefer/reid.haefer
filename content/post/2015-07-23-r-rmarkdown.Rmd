---
title: "Backcountry Ski Tours"
author: "Reid Haefer"
date: 2019-07-23
categories: ["R"]
tags: ["R Markdown", "mapping", "regression"]
---

Information about snowpack and weather conditions is important for safe and enjoyable experiences skiing in the backcountry. I track my ski tours using GAIA GPS and record information on each tour, such as elevation gain, weather, and other observations. This rmarkdown webapp displays some of the backcountry ski tours I've taken over the last few years.

```{r warning=F, message=F, echo=F}
library(pacman)
p_load(gsheet, knitr,raster,leaflet,rsconnect,datasets, tidyverse,  maptools, geojsonio, tidyverse, gganimate, rgdal, ggplot2, devtools, ggthemes, gtools, scales, DT, RColorBrewer, Rserve, leaflet.extras, sf, ggmap, ggspatial)

all<-geojson_read("static/post/2015-07-23-r-rmarkdown_files/all_ski_tours.geojson", what="sp") %>% st_as_sf() 
#load new tour geojson tracks
#maggies<-geojson_read("ski_tours/track-31019-93430am.geojson", what="sp") %>% st_as_sf() %>%
 #mutate(name= "maggies", id=53)
#new <- rbind(maggies) %>%
 #select(id, name)
#combine the new tracks with the all the other
#all <- rbind(all, new)
#st_write(all, dsn="ski_tours/all_ski_tours.geojson", driver="GeoJSON", delete_dsn = T)

data1 <- data.frame(gsheet2tbl("https://docs.google.com/spreadsheets/d/151RiUSQP0qMcUCGk9iO2zz7cdMbmOt64IiwzndeFWbI/edit?usp=sharing"))
all1 <- all %>% left_join(data1,  by="id")

#custom topographic map created with Mapbox
topo <- "https://api.mapbox.com/styles/v1/reidhaefer/cizzrfkq7007d2ss1ob7e2j43/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoicmVpZGhhZWZlciIsImEiOiJjaW80bW92cGowMW8zdjRrcWlsMzg5dGVjIn0.TxdQscN__5Nlu_jSYxZplA"
mb_attribution <- "<a href='https://www.mapbox.com/map-feedback/'>Mapbox</a> <a href='http://www.openstreetmap.org/copyright'>OpenStreetMap</a>"

#custom base map map created with Mapbox
base_map <- "https://api.mapbox.com/styles/v1/reidhaefer/cj04a1fmm00332sroid5qzzwb/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoicmVpZGhhZWZlciIsImEiOiJjaW80bW92cGowMW8zdjRrcWlsMzg5dGVjIn0.TxdQscN__5Nlu_jSYxZplA"
mb_attribution <- "<a href='https://www.mapbox.com/map-feedback/'>Mapbox</a> <a href='http://www.openstreetmap.org/copyright'>OpenStreetMap</a>"

leaflet(width=900, height=700) %>%
 # addMarkers(
   # lng = -121.8144, lat = 48.7767,
   # label = "Label w/o surrounding box",
   # labelOptions = labelOptions(noHide = T, textOnly = TRUE)) %>%
  addPopups(-120.098557, 38.946174, "recent trip", options = popupOptions(closeButton = FALSE)) %>%
  addTiles() %>%
 # addProviderTiles(providers$OpenStreetMap.BlackAndWhite) %>%
 # addTiles(urlTemplate = base_map, attribution = mb_attribution, group="Base Map") %>%
 # addTiles(urlTemplate = topo, attribution = mb_attribution, group="Topographic") %>%
 # addProviderTiles("Esri.WorldImagery", group="Satellite") %>%
  addPolylines(data=all1, weight=4, color="red", label=~paste(name,"-",general.area),
               popup=paste(sep="<br/>",paste("<b>Tour Name:</b> ",all1$name),
                           paste("<b>Date:</b> ",all1$date),
                           paste("<b>Location:</b> ",all1$general.area),
                           paste("<b>Distance:</b> ",all1$distance..mile., "miles"),
                           paste("<b>Elevation Gained:</b> ",all1$elevation.gain..ft., "feet"),
                           paste("<b>Weather:</b> ",all1$weather),
                           paste("<b>Avalanche Forecast:</b> ",all1$nwac.avy.rating),
                           paste0("<a href=", "\"", all1$photos, "\"", "target=", "\"","blank", "\"", ">","Photos" ,"</a>")),
               highlightOptions = highlightOptions(color = "#02f9dd", weight = 2, bringToFront = TRUE)) %>%
  addMiniMap(toggleDisplay = TRUE, tiles=providers$OpenStreetMap.BlackAndWhite) %>%
  addEasyButton(easyButton(icon="fa-globe", title="Zoom to Level 1", onClick=JS("function(btn, map){ map.setZoom(6); }"))) %>%
  addLegend("topright", title= "Backcountry Ski Tours", colors= "#c60905", labels= "ski tour") #%>%
  #addLayersControl(baseGroups = c("Topographic","Base Map",  "Satellite"), options = layersControlOptions(collapsed = FALSE))
```

```{r warning=F, message=F, echo=F}
data_table<-all1 %>% 
  data.frame() %>% 
  dplyr::select(date, general.area, tour.name, nwac.avy.rating, weather, duration, elevation.gain..ft., distance..mile., photos ) %>%
  mutate(photos = paste0("<a href=", "\"", photos, "\"", "target=", "\"","blank", "\"", ">", tour.name, "</a>"),
  distance..mile. = paste(distance..mile., "miles"),
elevation.gain..ft.= paste(elevation.gain..ft., "ft"))
colnames(data_table)<-c("Date", "Area", "Tour Name", "Avalanche Danger", "Weather", "Duration", "Elevation Gain", "Distance" ,"Photos")
data_table <- data_table %>%
  mutate(Date = as.Date(Date, "%m/%d/%Y"))
data_table<-data_table[order(as.Date(data_table$Date, format="%m/%d/%Y"), decreasing = TRUE),]
data_table$Date<-as.Date(data_table$Date, "%m/%d/%Y")
data_table$Date<-format(data_table$Date, "%B %d, %Y")
data_table <- data_table[complete.cases(data_table),]

DT::datatable(data_table, rownames=FALSE, escape=FALSE, options=list(pageLength = 100, dom = 'ft'))
```

